(ns examples.net-test.core
  "Network test example demonstrating the high-level networking API.
   Run with: ./run net-test server
         or: ./run net-test client"
  (:require [engine.networking.protocol :as net]))

(defn handle-server-event
  "Handle a single server event. Returns true to continue, false to stop."
  [server event]
  (case (:type event)
    :connect
    (do
      (println (str "Client " (:connection-id event) " connected"))
      true)

    :disconnect
    (do
      (println (str "Client " (:connection-id event) " disconnected"))
      true)

    :message
    (let [msg (:message event)
          conn-id (:connection-id event)]
      (println (str "Received from client " conn-id ": " msg))
      ;; Echo the message back with :echo type
      (net/send! server {:to conn-id
                         :message {:type :echo
                                   :original msg}})
      true)

    ;; Continue on unknown events
    true))

(defn run-server
  "Run an echo server on port 7777."
  []
  (println "Starting server on port 7777...")

  (let [server (net/start-server {:port 7777 :max-clients 32})]
    (if server
      (do
        (println "Server listening. Press Ctrl+C to stop.")
        ;; Use the helper loop function
        (net/run-server-loop! server handle-server-event {:poll-timeout 100})
        ;; Cleanup (only reached if loop exits)
        (net/stop server)
        (println "Server stopped."))
      (println "ERROR: Failed to start server"))))

(defn run-client
  "Connect to server at localhost:7777 and send test messages."
  []
  (println "Starting client, connecting to localhost:7777...")

  (let [client (net/start-client {:address "127.0.0.1" :port 7777})]
    (if client
      (do
        ;; Wait for connection with 5 second timeout
        (if (net/wait-for-connection! client 5000)
          (do
            (println "Connected to server!")

            ;; Send a hello message
            (net/send! client {:message {:type :hello
                                         :text "Hello from Jank client!"}})
            (println "Sent: {:type :hello, :text \"Hello from Jank client!\"}")

            ;; Receive loop - exchange a few messages
            (loop [msg-count 0]
              (when (< msg-count 5)
                (let [events (net/poll-events! client 1000)]
                  (doseq [event events]
                    (case (:type event)
                      :message
                      (println (str "Received: " (:message event)))

                      :disconnect
                      (println "Disconnected from server")

                      nil))

                  ;; Send another message if no events
                  (when (empty? events)
                    (let [msg {:type :ping
                               :count (inc msg-count)
                               :text (str "Message #" (inc msg-count))}]
                      (net/send! client {:message msg})
                      (println (str "Sent: " msg))))

                  (recur (inc msg-count)))))

            (println "Disconnecting..."))

          ;; Connection timeout
          (println "ERROR: Connection timed out"))

        ;; Cleanup
        (net/stop client))
      (println "ERROR: Failed to start client")))

  (println "Client finished."))

(defn -main
  ([] (-main "help"))
  ([mode]
   (cond
     (= mode "server")
     (run-server)

     (= mode "client")
     (run-client)

     :else
     (do
       (println "Usage: ./run net-test <mode>")
       (println "  server - Run echo server on port 7777")
       (println "  client - Connect to server and send test messages")))))
