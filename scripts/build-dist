#!/usr/bin/env bash
# Build and package the client distribution
set -euo pipefail

# Resolve symlinks to find actual script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

# Load platform abstraction
source "$SCRIPT_DIR/platform/common.sh"
require_platform_support

GAME="${1:-demo}"
APP_NAME="Demo"

echo "=== Building $GAME distribution for $PLATFORM ==="

# Clean previous build
rm -rf "$PROJECT_DIR/dist" 2>/dev/null || true
mkdir -p "$PROJECT_DIR/dist"

# Compile
echo ""
echo "=== Compiling ==="
"$SCRIPT_DIR/compile" "$GAME"

# Package for distribution (platform-specific)
echo ""
echo "=== Packaging ==="
"$SCRIPT_DIR/package-client" "$GAME"

# Create zip
echo ""
echo "=== Creating zip ==="
cd "$PROJECT_DIR/dist"
rm -f "${APP_NAME}.zip"
zip -ryq "${APP_NAME}.zip" "${APP_NAME}.app" README.txt

# Get sizes before cleanup
SIZE=$(du -sh "${APP_NAME}.app" | cut -f1)
ZIP_SIZE=$(ls -lh "${APP_NAME}.zip" | awk '{print $5}')

# Clean up everything except the zip
rm -rf "${APP_NAME}.app" README.txt bin lib demo_run 2>/dev/null || true

echo ""
echo "============================================================================="
echo "Distribution built successfully!"
echo ""
echo "  dist/${APP_NAME}.zip  ($ZIP_SIZE, uncompressed: $SIZE)"
echo ""
echo "To test: unzip dist/${APP_NAME}.zip -d /tmp && open /tmp/${APP_NAME}.app"
echo ""
echo "End-user requirements:"
echo "  - macOS 11+ (Apple Silicon)"
echo "  - XCode Command Line Tools: xcode-select --install"
echo "  - First launch: Right-click -> Open -> Open"
echo "============================================================================="
