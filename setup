#!/usr/bin/env bash
set -euo pipefail

echo "=== Setting up opengl-with-jank ==="

# Initialize submodules if needed
echo "Initializing submodules..."
git submodule update --init --recursive

# Build ozz-animation
echo "Building ozz-animation..."
cd third_party/ozz-animation
mkdir -p build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON
make -j8

# Copy libraries
echo "Installing ozz-animation libraries..."
cp src/base/libozz_base_r.dylib ../../../libs/ozz-animation/lib/
cp src/animation/runtime/libozz_animation_r.dylib ../../../libs/ozz-animation/lib/
cp src/geometry/runtime/libozz_geometry_r.dylib ../../../libs/ozz-animation/lib/

cd ../../..

# Build OpenGL stub library (allows linking via -lOpenGL instead of -framework)
echo "Building OpenGL stub library..."
mkdir -p libs/opengl/lib
clang -dynamiclib -o libs/opengl/lib/libOpenGL.dylib \
  -framework OpenGL \
  -install_name "@rpath/libOpenGL.dylib" \
  -Wl,-reexport_framework,OpenGL

echo ""
echo "=== Setup complete ==="
echo "Run with: ./run"
echo "Compile with: ./compile"
