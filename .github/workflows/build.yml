name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'Skip LLVM cache (force rebuild)'
        type: boolean
        default: false

env:
  JANK_REPO: cjbarre/jank
  JANK_BRANCH: add-windows

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux-x86_64
            arch: x64
          - os: ubuntu-24.04-arm
            platform: linux-arm64
            arch: arm64
          - os: macos-14
            platform: macos-arm64
            arch: arm64

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.platform }})

    steps:
      - name: Checkout game repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build git git-lfs \
            libssl-dev libdouble-conversion-dev pkg-config \
            zlib1g-dev libffi-dev libbz2-dev libzstd-dev \
            libgl1-mesa-dev libglew-dev \
            libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
            doctest-dev patchelf \
            gcc-14 g++-14 libstdc++-14-dev

      - name: Set GCC 14 as default (Linux)
        if: runner.os == 'Linux'
        run: |
          # GCC 14 required for std::chrono::parse support
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100 \
            --slave /usr/bin/g++ g++ /usr/bin/g++-14

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja git-lfs openssl double-conversion pkg-config python gnupg zlib doctest
          echo "SDKROOT=$(xcrun --sdk macosx --show-sdk-path)" >> $GITHUB_ENV

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@12.5
        with:
          cli: latest

      - name: Clone jank
        run: |
          git clone --recurse-submodules --depth 1 -b ${{ env.JANK_BRANCH }} \
            https://github.com/${{ env.JANK_REPO }}.git jank

      - name: Get LLVM cache key
        id: llvm-cache-key
        run: |
          # Use jank commit hash + build script hash for stable cache key
          JANK_COMMIT=$(cd jank && git rev-parse HEAD)
          BUILD_SCRIPT_HASH=$(sha256sum jank/compiler+runtime/bin/build-clang | cut -d' ' -f1)
          echo "key=llvm-${{ matrix.platform }}-${JANK_COMMIT:0:12}-${BUILD_SCRIPT_HASH:0:12}" >> $GITHUB_OUTPUT
          echo "Cache key: llvm-${{ matrix.platform }}-${JANK_COMMIT:0:12}-${BUILD_SCRIPT_HASH:0:12}"

      - name: Cache LLVM build
        id: cache-llvm
        if: ${{ !inputs.skip_cache }}
        uses: actions/cache@v4
        with:
          path: jank/compiler+runtime/build/llvm-install
          key: ${{ steps.llvm-cache-key.outputs.key }}
          restore-keys: |
            llvm-${{ matrix.platform }}-

      - name: Build LLVM (if not cached)
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        working-directory: jank/compiler+runtime
        run: |
          echo "Cache miss - building LLVM from scratch..."
          export CC=clang CXX=clang++
          ./bin/build-clang
        timeout-minutes: 180

      - name: Verify LLVM cache
        run: |
          echo "LLVM install directory contents:"
          ls -la jank/compiler+runtime/build/llvm-install/usr/local/bin/ | head -10
          echo "Cache hit: ${{ steps.cache-llvm.outputs.cache-hit }}"

      - name: Build jank
        working-directory: jank/compiler+runtime
        run: |
          export CC=$PWD/build/llvm-install/usr/local/bin/clang
          export CXX=$PWD/build/llvm-install/usr/local/bin/clang++
          ./bin/configure -GNinja -DCMAKE_BUILD_TYPE=Release -Djank_local_clang=on
          ./bin/compile

      - name: Install jank
        working-directory: jank/compiler+runtime
        run: |
          # Install jank to a local prefix so resource directories are set up correctly
          cmake --install build --prefix ${{ github.workspace }}/jank-install

      - name: Add jank to PATH
        run: |
          echo "${{ github.workspace }}/jank-install/bin" >> $GITHUB_PATH
          echo "JANK_DIR=${{ github.workspace }}/jank/compiler+runtime" >> $GITHUB_ENV

      - name: Verify jank installation
        run: |
          jank --help
          jank run -e '(println "jank is working!")'

      - name: Build game libraries (Linux)
        if: runner.os == 'Linux'
        run: |
          LIBS_DIR="libs/${{ matrix.platform }}"

          # Build GLFW if not present
          if [ ! -f "$LIBS_DIR/glfw/lib/libglfw.so.3" ]; then
            git clone --depth 1 -b 3.4 https://github.com/glfw/glfw.git /tmp/glfw
            cmake -S /tmp/glfw -B /tmp/glfw/build \
              -DCMAKE_BUILD_TYPE=Release \
              -DBUILD_SHARED_LIBS=ON \
              -DGLFW_BUILD_WAYLAND=OFF \
              -DGLFW_BUILD_EXAMPLES=OFF \
              -DGLFW_BUILD_TESTS=OFF \
              -DGLFW_BUILD_DOCS=OFF
            cmake --build /tmp/glfw/build -j$(nproc)
            mkdir -p "$LIBS_DIR/glfw/lib" "$LIBS_DIR/glfw/include/GLFW"
            cp /tmp/glfw/build/src/libglfw.so.3* "$LIBS_DIR/glfw/lib/"
            ln -sf libglfw.so.3 "$LIBS_DIR/glfw/lib/libglfw.so"
            cp /tmp/glfw/include/GLFW/*.h "$LIBS_DIR/glfw/include/GLFW/"
          fi

          # Build ozz-animation
          if [ ! -f "$LIBS_DIR/ozz-animation/lib/libozz_animation_r.so" ]; then
            cmake -S third_party/ozz-animation -B third_party/ozz-animation/build \
              -DCMAKE_BUILD_TYPE=Release \
              -DBUILD_SHARED_LIBS=ON \
              -Dozz_build_tools=OFF \
              -Dozz_build_samples=OFF \
              -Dozz_build_tests=OFF
            cmake --build third_party/ozz-animation/build -j$(nproc)
            mkdir -p "$LIBS_DIR/ozz-animation/lib" "$LIBS_DIR/ozz-animation/include"
            cp third_party/ozz-animation/build/src/animation/runtime/libozz_animation_r.so "$LIBS_DIR/ozz-animation/lib/"
            cp third_party/ozz-animation/build/src/base/libozz_base_r.so "$LIBS_DIR/ozz-animation/lib/"
            cp third_party/ozz-animation/build/src/geometry/runtime/libozz_geometry_r.so "$LIBS_DIR/ozz-animation/lib/"
            cp -r third_party/ozz-animation/include/ozz "$LIBS_DIR/ozz-animation/include/"
          fi

          # Build stb
          if [ ! -f "$LIBS_DIR/stb/lib/libstb_all.so" ]; then
            mkdir -p "$LIBS_DIR/stb/lib"
            cat > /tmp/stb_impl.c << 'STBEOF'
          #define STBI_NO_THREAD_LOCALS 1
          #define STB_IMAGE_IMPLEMENTATION
          #include "stb_image.h"
          #define STB_TRUETYPE_IMPLEMENTATION
          #include "stb_truetype.h"
          STBEOF
            gcc -shared -fPIC -O2 -o "$LIBS_DIR/stb/lib/libstb_all.so" /tmp/stb_impl.c -Iinclude -lm
          fi

          # Build enet (MUST use project's single-header include/enet.h for correct symbols)
          if [ ! -f "$LIBS_DIR/enet/lib/libenet.so" ]; then
            mkdir -p "$LIBS_DIR/enet/lib"
            cat > /tmp/enet_impl.c << 'ENETEOF'
          #define ENET_IMPLEMENTATION
          #include "enet.h"
          ENETEOF
            gcc -shared -fPIC -O2 -o "$LIBS_DIR/enet/lib/libenet.so" /tmp/enet_impl.c -Iinclude -lm
          fi

          # Build cgltf
          if [ ! -f "$LIBS_DIR/cgltf/lib/libcgltf.so" ]; then
            mkdir -p "$LIBS_DIR/cgltf/lib"
            cat > /tmp/cgltf_impl.c << 'CGLTFEOF'
          #define CGLTF_IMPLEMENTATION
          #include "cgltf.h"
          CGLTFEOF
            gcc -shared -fPIC -O2 -o "$LIBS_DIR/cgltf/lib/libcgltf.so" /tmp/cgltf_impl.c -Iinclude
          fi

          mkdir -p "$LIBS_DIR/opengl/lib"

      - name: Compile game (Linux)
        if: runner.os == 'Linux'
        run: |
          LIBS_DIR="libs/${{ matrix.platform }}"

          # Detect system library path based on architecture
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            SYS_LIB_PATH="/usr/lib/aarch64-linux-gnu"
          else
            SYS_LIB_PATH="/usr/lib/x86_64-linux-gnu"
          fi

          export LD_LIBRARY_PATH="$LIBS_DIR/glfw/lib:$LIBS_DIR/ozz-animation/lib:$LIBS_DIR/stb/lib:$LIBS_DIR/enet/lib:$LIBS_DIR/cgltf/lib:$SYS_LIB_PATH"

          jank \
            -I"$LIBS_DIR/glfw/include" -I libs/glm -I include -I"$LIBS_DIR/ozz-animation/include" \
            -L"$LIBS_DIR/glfw/lib" -lglfw \
            -L"$LIBS_DIR/ozz-animation/lib" -lozz_animation_r -lozz_base_r -lozz_geometry_r \
            -L"$LIBS_DIR/stb/lib" -lstb_all \
            -L"$LIBS_DIR/enet/lib" -lenet \
            -L"$LIBS_DIR/cgltf/lib" -lcgltf \
            -I/usr/include -L"$SYS_LIB_PATH" -lGL -lGLEW \
            --module-path "$JANK_DIR/src/jank:src" \
            compile examples.demo.core -o demo

      - name: Compile game (macOS)
        if: runner.os == 'macOS'
        run: |
          LIBS_DIR="libs/${{ matrix.platform }}"

          jank \
            -I"$LIBS_DIR/glfw/include" -I libs/glm -I include -I"$LIBS_DIR/ozz-animation/include" \
            -L"$LIBS_DIR/glfw/lib" -lglfw.3 \
            -L"$LIBS_DIR/ozz-animation/lib" -lozz_animation_r -lozz_base_r -lozz_geometry_r \
            -L"$LIBS_DIR/stb/lib" -lstb_all \
            -L"$LIBS_DIR/enet/lib" -lenet \
            -L"$LIBS_DIR/cgltf/lib" -lcgltf \
            --module-path "$JANK_DIR/src/jank:src" \
            compile examples.demo.core -o demo

      - name: Package distribution (Linux)
        if: runner.os == 'Linux'
        run: |
          LIBS_DIR="libs/${{ matrix.platform }}"
          JANK_LLVM="${{ github.workspace }}/jank/compiler+runtime/build/llvm-install/usr/local"
          JANK_SRC="${{ github.workspace }}/jank/compiler+runtime"

          mkdir -p dist/bin dist/lib dist/lib/jank/0.1/{bin,include,lib/clang,src}

          # Copy game binary and libraries
          cp demo dist/bin/
          cp "$LIBS_DIR"/*/lib/*.so* dist/lib/ 2>/dev/null || true
          cp -r shaders textures models fonts dist/

          # Bundle LLVM shared libraries for JIT
          cp "$JANK_LLVM/lib/libclang-cpp.so"* dist/lib/ 2>/dev/null || true
          cp "$JANK_LLVM/lib/libLLVM.so"* dist/lib/ 2>/dev/null || true

          # Bundle clang for JIT compilation
          cp "$JANK_LLVM/bin/clang-22" dist/lib/jank/0.1/bin/
          ln -sf clang-22 dist/lib/jank/0.1/bin/clang++
          ln -sf clang-22 dist/lib/jank/0.1/bin/clang

          # Bundle clang resources
          cp -R "$JANK_LLVM/lib/clang/22" dist/lib/jank/0.1/lib/clang/

          # Bundle libc++ headers
          cp -R "$JANK_LLVM/include/c++" dist/lib/jank/0.1/include/ 2>/dev/null || true

          # Bundle jank headers and stdlib
          cp -R "$JANK_SRC/include/cpp/jank" dist/lib/jank/0.1/include/
          cp -R "$JANK_SRC/src/jank"/* dist/lib/jank/0.1/src/

          # Bundle GCC 14 libstdc++ headers for JIT
          mkdir -p dist/lib/jank/0.1/include/c++
          cp -R /usr/include/c++/14 dist/lib/jank/0.1/include/c++/ 2>/dev/null || true

          # Architecture-specific headers
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            mkdir -p dist/lib/jank/0.1/include/aarch64-linux-gnu/c++
            cp -R /usr/include/aarch64-linux-gnu/c++/14 dist/lib/jank/0.1/include/aarch64-linux-gnu/c++/ 2>/dev/null || true
          else
            mkdir -p dist/lib/jank/0.1/include/x86_64-linux-gnu/c++
            cp -R /usr/include/x86_64-linux-gnu/c++/14 dist/lib/jank/0.1/include/x86_64-linux-gnu/c++/ 2>/dev/null || true
          fi

          # Fix clang rpath to find LLVM libs
          patchelf --add-rpath '$ORIGIN/../../../lib' dist/lib/jank/0.1/bin/clang-22 2>/dev/null || true

          cat > dist/demo_run << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$LD_LIBRARY_PATH"
          export PATH="$SCRIPT_DIR/lib/jank/0.1/bin:$PATH"
          cd "$SCRIPT_DIR"
          exec "./bin/demo" "$@"
          EOF
          chmod +x dist/demo_run

      - name: Package distribution (macOS)
        if: runner.os == 'macOS'
        run: |
          LIBS_DIR="libs/${{ matrix.platform }}"
          JANK_LLVM="${{ github.workspace }}/jank/compiler+runtime/build/llvm-install/usr/local"
          JANK_SRC="${{ github.workspace }}/jank/compiler+runtime"

          mkdir -p dist/bin dist/lib dist/lib/jank/0.1/{bin,include,lib/clang,src}

          # Copy game binary and libraries
          cp demo dist/bin/
          cp "$LIBS_DIR"/*/lib/*.dylib dist/lib/ 2>/dev/null || true
          cp -r shaders textures models fonts dist/

          # Bundle LLVM shared libraries for JIT
          cp "$JANK_LLVM/lib/libclang-cpp.dylib" dist/lib/ 2>/dev/null || true
          cp "$JANK_LLVM/lib/libLLVM.dylib" dist/lib/ 2>/dev/null || true
          cp "$JANK_LLVM/lib/libc++.1.dylib" dist/lib/ 2>/dev/null || true
          cp "$JANK_LLVM/lib/libunwind.1.dylib" dist/lib/ 2>/dev/null || true

          # Bundle clang for JIT compilation
          cp "$JANK_LLVM/bin/clang-22" dist/lib/jank/0.1/bin/
          ln -sf clang-22 dist/lib/jank/0.1/bin/clang++
          ln -sf clang-22 dist/lib/jank/0.1/bin/clang

          # Bundle clang resources
          cp -R "$JANK_LLVM/lib/clang/22" dist/lib/jank/0.1/lib/clang/

          # Bundle libc++ headers
          cp -R "$JANK_LLVM/include/c++" dist/lib/jank/0.1/include/ 2>/dev/null || true

          # Bundle jank headers and stdlib
          cp -R "$JANK_SRC/include/cpp/jank" dist/lib/jank/0.1/include/
          cp -R "$JANK_SRC/src/jank"/* dist/lib/jank/0.1/src/

          # Fix clang rpath
          install_name_tool -add_rpath @executable_path/../../../lib dist/lib/jank/0.1/bin/clang-22 2>/dev/null || true

          cat > dist/demo_run << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          export DYLD_LIBRARY_PATH="$SCRIPT_DIR/lib:$DYLD_LIBRARY_PATH"
          export PATH="$SCRIPT_DIR/lib/jank/0.1/bin:$PATH"
          cd "$SCRIPT_DIR"
          exec "./bin/demo" "$@"
          EOF
          chmod +x dist/demo_run

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: demo-${{ matrix.platform }}
          path: dist/
          retention-days: 30
