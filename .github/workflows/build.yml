name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux-x86_64
            arch: x64
          - os: ubuntu-24.04-arm
            platform: linux-arm64
            arch: arm64
          - os: macos-14
            platform: macos-arm64
            arch: arm64

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.platform }})

    steps:
      - name: Checkout game repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install jank and dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          # Install jank from PPA
          sudo apt-get update
          sudo apt-get install -y curl gnupg
          curl -s "https://ppa.jank-lang.org/KEY.gpg" | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/jank.gpg >/dev/null
          sudo curl -s -o /etc/apt/sources.list.d/jank.list "https://ppa.jank-lang.org/jank.list"
          sudo apt-get update
          sudo apt-get install -y jank

          # Install build dependencies
          sudo apt-get install -y \
            build-essential cmake ninja-build \
            libgl1-mesa-dev libglew-dev \
            libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
            patchelf \
            gcc-14 g++-14 libstdc++-14-dev

      - name: Set GCC 14 as default (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100 \
            --slave /usr/bin/g++ g++ /usr/bin/g++-14

      - name: Install jank and dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install jank-lang/jank/jank
          brew install cmake ninja
          echo "SDKROOT=$(xcrun --sdk macosx --show-sdk-path)" >> $GITHUB_ENV

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@12.5
        with:
          cli: latest

      - name: Verify jank installation
        run: |
          which jank
          jank run -e '(println "jank is working!")'

      - name: Set jank paths
        id: jank-paths
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            echo "JANK_LIB=/usr/local/lib/jank/0.1" >> $GITHUB_ENV
            echo "JANK_MODULE_PATH=/usr/local/lib/jank/0.1/src/jank" >> $GITHUB_ENV
          else
            # macOS Homebrew
            JANK_PREFIX="$(brew --prefix jank)"
            echo "JANK_LIB=$JANK_PREFIX/lib/jank/0.1" >> $GITHUB_ENV
            echo "JANK_MODULE_PATH=$JANK_PREFIX/lib/jank/0.1/src/jank" >> $GITHUB_ENV
          fi

      - name: Build game libraries (Linux)
        if: runner.os == 'Linux'
        run: |
          LIBS_DIR="libs/${{ matrix.platform }}"

          # Build GLFW if not present
          if [ ! -f "$LIBS_DIR/glfw/lib/libglfw.so.3" ]; then
            git clone --depth 1 -b 3.4 https://github.com/glfw/glfw.git /tmp/glfw
            cmake -S /tmp/glfw -B /tmp/glfw/build \
              -DCMAKE_BUILD_TYPE=Release \
              -DBUILD_SHARED_LIBS=ON \
              -DGLFW_BUILD_WAYLAND=OFF \
              -DGLFW_BUILD_EXAMPLES=OFF \
              -DGLFW_BUILD_TESTS=OFF \
              -DGLFW_BUILD_DOCS=OFF
            cmake --build /tmp/glfw/build -j$(nproc)
            mkdir -p "$LIBS_DIR/glfw/lib" "$LIBS_DIR/glfw/include/GLFW"
            cp /tmp/glfw/build/src/libglfw.so.3* "$LIBS_DIR/glfw/lib/"
            ln -sf libglfw.so.3 "$LIBS_DIR/glfw/lib/libglfw.so"
            cp /tmp/glfw/include/GLFW/*.h "$LIBS_DIR/glfw/include/GLFW/"
          fi

          # Build ozz-animation
          if [ ! -f "$LIBS_DIR/ozz-animation/lib/libozz_animation_r.so" ]; then
            cmake -S third_party/ozz-animation -B third_party/ozz-animation/build \
              -DCMAKE_BUILD_TYPE=Release \
              -DBUILD_SHARED_LIBS=ON \
              -Dozz_build_tools=OFF \
              -Dozz_build_samples=OFF \
              -Dozz_build_tests=OFF
            cmake --build third_party/ozz-animation/build -j$(nproc)
            mkdir -p "$LIBS_DIR/ozz-animation/lib" "$LIBS_DIR/ozz-animation/include"
            cp third_party/ozz-animation/build/src/animation/runtime/libozz_animation_r.so "$LIBS_DIR/ozz-animation/lib/"
            cp third_party/ozz-animation/build/src/base/libozz_base_r.so "$LIBS_DIR/ozz-animation/lib/"
            cp third_party/ozz-animation/build/src/geometry/runtime/libozz_geometry_r.so "$LIBS_DIR/ozz-animation/lib/"
            cp -r third_party/ozz-animation/include/ozz "$LIBS_DIR/ozz-animation/include/"
          fi

          # Build stb
          if [ ! -f "$LIBS_DIR/stb/lib/libstb_all.so" ]; then
            mkdir -p "$LIBS_DIR/stb/lib"
            cat > /tmp/stb_impl.c << 'STBEOF'
          #define STBI_NO_THREAD_LOCALS 1
          #define STB_IMAGE_IMPLEMENTATION
          #include "stb_image.h"
          #define STB_TRUETYPE_IMPLEMENTATION
          #include "stb_truetype.h"
          STBEOF
            gcc -shared -fPIC -O2 -o "$LIBS_DIR/stb/lib/libstb_all.so" /tmp/stb_impl.c -Iinclude -lm
          fi

          # Build enet
          if [ ! -f "$LIBS_DIR/enet/lib/libenet.so" ]; then
            mkdir -p "$LIBS_DIR/enet/lib"
            cat > /tmp/enet_impl.c << 'ENETEOF'
          #define ENET_IMPLEMENTATION
          #include "enet.h"
          ENETEOF
            gcc -shared -fPIC -O2 -o "$LIBS_DIR/enet/lib/libenet.so" /tmp/enet_impl.c -Iinclude -lm
          fi

          # Build cgltf
          if [ ! -f "$LIBS_DIR/cgltf/lib/libcgltf.so" ]; then
            mkdir -p "$LIBS_DIR/cgltf/lib"
            cat > /tmp/cgltf_impl.c << 'CGLTFEOF'
          #define CGLTF_IMPLEMENTATION
          #include "cgltf.h"
          CGLTFEOF
            gcc -shared -fPIC -O2 -o "$LIBS_DIR/cgltf/lib/libcgltf.so" /tmp/cgltf_impl.c -Iinclude
          fi

          mkdir -p "$LIBS_DIR/opengl/lib"

      - name: Compile game (Linux)
        if: runner.os == 'Linux'
        run: |
          LIBS_DIR="libs/${{ matrix.platform }}"

          # Detect system library path based on architecture
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            SYS_LIB_PATH="/usr/lib/aarch64-linux-gnu"
          else
            SYS_LIB_PATH="/usr/lib/x86_64-linux-gnu"
          fi

          export LD_LIBRARY_PATH="$LIBS_DIR/glfw/lib:$LIBS_DIR/ozz-animation/lib:$LIBS_DIR/stb/lib:$LIBS_DIR/enet/lib:$LIBS_DIR/cgltf/lib:$SYS_LIB_PATH:$JANK_LIB/lib"

          jank \
            -I"$LIBS_DIR/glfw/include" -I libs/glm -I include -I"$LIBS_DIR/ozz-animation/include" \
            -L"$LIBS_DIR/glfw/lib" -lglfw \
            -L"$LIBS_DIR/ozz-animation/lib" -lozz_animation_r -lozz_base_r -lozz_geometry_r \
            -L"$LIBS_DIR/stb/lib" -lstb_all \
            -L"$LIBS_DIR/enet/lib" -lenet \
            -L"$LIBS_DIR/cgltf/lib" -lcgltf \
            -I/usr/include -L"$SYS_LIB_PATH" -lGL -lGLEW \
            --module-path "$JANK_MODULE_PATH:src" \
            compile examples.demo.core -o demo

      - name: Compile game (macOS)
        if: runner.os == 'macOS'
        run: |
          LIBS_DIR="libs/${{ matrix.platform }}"

          jank \
            -I"$LIBS_DIR/glfw/include" -I libs/glm -I include -I"$LIBS_DIR/ozz-animation/include" \
            -L"$LIBS_DIR/glfw/lib" -lglfw.3 \
            -L"$LIBS_DIR/ozz-animation/lib" -lozz_animation_r -lozz_base_r -lozz_geometry_r \
            -L"$LIBS_DIR/stb/lib" -lstb_all \
            -L"$LIBS_DIR/enet/lib" -lenet \
            -L"$LIBS_DIR/cgltf/lib" -lcgltf \
            --module-path "$JANK_MODULE_PATH:src" \
            compile examples.demo.core -o demo

      - name: Package distribution (Linux)
        if: runner.os == 'Linux'
        run: |
          LIBS_DIR="libs/${{ matrix.platform }}"

          mkdir -p dist/bin dist/lib dist/lib/jank/0.1/{bin,include,lib/clang,src}

          # Copy game binary and libraries
          cp demo dist/bin/
          cp "$LIBS_DIR"/*/lib/*.so* dist/lib/ 2>/dev/null || true
          cp -r shaders textures models fonts dist/

          # Bundle LLVM shared libraries for JIT
          cp "$JANK_LIB/lib/libclang-cpp.so"* dist/lib/ 2>/dev/null || true
          cp "$JANK_LIB/lib/libLLVM.so"* dist/lib/ 2>/dev/null || true

          # Bundle clang for JIT compilation
          cp "$JANK_LIB/bin/clang-22" dist/lib/jank/0.1/bin/
          ln -sf clang-22 dist/lib/jank/0.1/bin/clang++
          ln -sf clang-22 dist/lib/jank/0.1/bin/clang

          # Bundle clang resources
          cp -R "$JANK_LIB/lib/clang/22" dist/lib/jank/0.1/lib/clang/

          # Bundle libc++ headers
          cp -R "$JANK_LIB/include/c++" dist/lib/jank/0.1/include/ 2>/dev/null || true

          # Bundle jank headers and stdlib
          cp -R "$JANK_LIB/include/jank" dist/lib/jank/0.1/include/
          cp -R "$JANK_LIB/src/jank"/* dist/lib/jank/0.1/src/

          # Bundle GCC 14 libstdc++ headers for JIT
          mkdir -p dist/lib/jank/0.1/include/c++
          cp -R /usr/include/c++/14 dist/lib/jank/0.1/include/c++/ 2>/dev/null || true

          # Architecture-specific headers
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            mkdir -p dist/lib/jank/0.1/include/aarch64-linux-gnu/c++
            cp -R /usr/include/aarch64-linux-gnu/c++/14 dist/lib/jank/0.1/include/aarch64-linux-gnu/c++/ 2>/dev/null || true
          else
            mkdir -p dist/lib/jank/0.1/include/x86_64-linux-gnu/c++
            cp -R /usr/include/x86_64-linux-gnu/c++/14 dist/lib/jank/0.1/include/x86_64-linux-gnu/c++/ 2>/dev/null || true
          fi

          # Fix clang rpath to find LLVM libs
          patchelf --add-rpath '$ORIGIN/../../../lib' dist/lib/jank/0.1/bin/clang-22 2>/dev/null || true

          cat > dist/demo_run << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$LD_LIBRARY_PATH"
          export PATH="$SCRIPT_DIR/lib/jank/0.1/bin:$PATH"
          cd "$SCRIPT_DIR"
          exec "./bin/demo" "$@"
          EOF
          chmod +x dist/demo_run

      - name: Package distribution (macOS)
        if: runner.os == 'macOS'
        run: |
          LIBS_DIR="libs/${{ matrix.platform }}"

          mkdir -p dist/bin dist/lib dist/lib/jank/0.1/{bin,include,lib/clang,src}

          # Copy game binary and libraries
          cp demo dist/bin/
          cp "$LIBS_DIR"/*/lib/*.dylib dist/lib/ 2>/dev/null || true
          cp -r shaders textures models fonts dist/

          # Bundle LLVM shared libraries for JIT
          cp "$JANK_LIB/lib/libclang-cpp.dylib" dist/lib/ 2>/dev/null || true
          cp "$JANK_LIB/lib/libLLVM.dylib" dist/lib/ 2>/dev/null || true
          cp "$JANK_LIB/lib/libc++.1.dylib" dist/lib/ 2>/dev/null || true
          cp "$JANK_LIB/lib/libunwind.1.dylib" dist/lib/ 2>/dev/null || true

          # Bundle clang for JIT compilation
          cp "$JANK_LIB/bin/clang-22" dist/lib/jank/0.1/bin/
          ln -sf clang-22 dist/lib/jank/0.1/bin/clang++
          ln -sf clang-22 dist/lib/jank/0.1/bin/clang

          # Bundle clang resources
          cp -R "$JANK_LIB/lib/clang/22" dist/lib/jank/0.1/lib/clang/

          # Bundle libc++ headers
          cp -R "$JANK_LIB/include/c++" dist/lib/jank/0.1/include/ 2>/dev/null || true

          # Bundle jank headers and stdlib
          cp -R "$JANK_LIB/include/jank" dist/lib/jank/0.1/include/
          cp -R "$JANK_LIB/src/jank"/* dist/lib/jank/0.1/src/

          # Fix clang rpath
          install_name_tool -add_rpath @executable_path/../../../lib dist/lib/jank/0.1/bin/clang-22 2>/dev/null || true

          cat > dist/demo_run << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          export DYLD_LIBRARY_PATH="$SCRIPT_DIR/lib:$DYLD_LIBRARY_PATH"
          export PATH="$SCRIPT_DIR/lib/jank/0.1/bin:$PATH"
          cd "$SCRIPT_DIR"
          exec "./bin/demo" "$@"
          EOF
          chmod +x dist/demo_run

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: demo-${{ matrix.platform }}
          path: dist/
          retention-days: 30
