#!/usr/bin/env bash
# Build and package the client distribution as a macOS .app bundle
set -euo pipefail

DIR="$(cd "$(dirname "$0")" && pwd)"
GAME="${1:-demo}"
APP_NAME="Demo"

echo "=== Building $GAME distribution ==="

# Clean previous build
rm -rf "$DIR/dist" 2>/dev/null || true
mkdir -p "$DIR/dist"

# Compile
echo ""
echo "=== Compiling ==="
"$DIR/compile" "$GAME"

# Package as .app bundle
echo ""
echo "=== Packaging ==="
"$DIR/package-client" "$GAME"

# Create zip
echo ""
echo "=== Creating zip ==="
cd "$DIR/dist"
rm -f "${APP_NAME}.zip"
zip -ryq "${APP_NAME}.zip" "${APP_NAME}.app" README.txt

# Get sizes before cleanup
SIZE=$(du -sh "${APP_NAME}.app" | cut -f1)
ZIP_SIZE=$(ls -lh "${APP_NAME}.zip" | awk '{print $5}')

# Clean up everything except the zip
rm -rf "${APP_NAME}.app" README.txt bin lib demo_run 2>/dev/null || true

echo ""
echo "============================================================================="
echo "Distribution built successfully!"
echo ""
echo "  dist/${APP_NAME}.zip  ($ZIP_SIZE, uncompressed: $SIZE)"
echo ""
echo "To test: unzip dist/${APP_NAME}.zip -d /tmp && open /tmp/${APP_NAME}.app"
echo ""
echo "End-user requirements:"
echo "  - macOS 11+ (Apple Silicon)"
echo "  - XCode Command Line Tools: xcode-select --install"
echo "  - First launch: Right-click -> Open -> Open"
echo "============================================================================="
